---
title: 'Project 1: Wrangling, Exploration, Visualization'
author: "SDS322E"
date: ''
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
  pdf_document:
    toc: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, fig.align = "center", warning = F, message = F,
tidy=TRUE, tidy.opts=list(width.cutoff=60), R.options=list(max.print=100))
```

## Data Wrangling, Exploration, Visualization

### Caroline Cummings, cac7659

#### Introduction 

When the Agricultural Revolution began in the 1940s, it initiated a global switch from small-scale subsistence farming to large-scale industrialized agriculture. As a result, humans have increasingly deforested and encroached upon natural lanscapes. Agricultural expansion is a leading driver of deforestation, and livestock prodution in particularly destructive because it requires a significant amount of land both to provide livestock space to live and to grow feed stock. In fact, cattle is the leading cause of deforestation in the Amazon and a majority of soy production in this region is used to feed cattle instead of humans. Agricultural expansion and intensification has also had negative implications on infectious disease emergence and spread. Land-use change is a major driver of the emergence of new infectious diseases and it can exacerbate the prevalence of endemic pathogens. Malaria cases is shown to increase when deforestation occurs due to a phenomenon called the "edge effect." When forests are fragmented (due to land-use change such as deforestation and agriculture), the wildlife-livestock-human interface can become disrupted and lead to ecosystem imbalances. Wildlife, livestock, and humans come in contact with each other more frequently and interact in abnormal ways due to increased surface area between natural and human-changed land. In areas where there is a significant forest edge, malaria incidence is shown to increase because a) an increased number of people become available food sources for mosquitoes, b) animals that usually serve as food sources to mosquitoes die or become displaced due to habitat loss, and c) forest edges provide suitable habitat for mosquitos. 

I chose to analyze datasets that contained the malaria cases per 100,000 people, percent of land used for agriculture, percent of land that is covered by forest, and the livestock production index for countries between the years 1995-2005 to see if there is a relationship between these variables (4 datasets total). The csv files for the datasets came from GapMinder. I expect for malaria cases, agricultural land, and livestock production to increase over time and for the forest cover to decrease. Understanding the relationship between these variables is especially important now as medical resources have shifted away from  prevention and treatment programs for endemic dieases, such as malaria, due to the reallocation of resources to combat COVID-19. 

```{R}
# read your datasets in here, e.g., with read_csv()
library(tidyverse)
library(dplyr)

agriculture<-read_csv("agriculture.csv")
forest<- read_csv("forest.csv")
livestock <- read_csv("livestock.csv")
forest_coverage <- read_csv("forest_coverage.csv")
malaria_prop <- read_csv("malaria_prop.csv")
```

#### Tidying: Reshaping

If your datasets are tidy already, demonstrate that you can reshape data with pivot wider/longer here (e.g., untidy and then retidy). Alternatively, it may be easier to wait until the wrangling section so you can reshape your summary statistics. Note here if you are going to do this.

For all 4 datasets, I used pivot_longer to create a column for the year variable for the years between 1995-2005. I used select to only pull data on my ID variable, the years 1995-2005, and the malaria/land-use data. My ID variable is "country," so to prevent the "year" column from duplicating when I joined the 4 datasets, I united the country and year columns. Also, I used an underscore to combine these data because if I used a space, it would be difficult to separate these data back into "country" and "year" because some countries are more than one word (ex: Papua New Guinea).

```{R}
#Demonstration that I can use pivot wider/longer:
tidy_forest<- forest_coverage %>% pivot_longer(c("1995":"2005"), names_to="year", values_to="forest_cover") %>% select(country, year, forest_cover)
tidy_forest %>% pivot_wider(names_from="year", values_from="forest_cover")

#Data used:
#Forest: The percent of a country's total land area that is covered in forest each year
forest_coverage1 <- forest_coverage %>% pivot_longer(c("1995":"2005"), names_to="year", values_to="forest_cover") %>% select(country, year, forest_cover)
new_forest<- forest_coverage1 %>% unite(country, year, col="country_year", sep="_")

#Malaria: malaria cases per 100,000 people each year
malaira_prop1 <- malaria_prop %>% pivot_longer(c("1995":"2005"), names_to="year", values_to="malaria") %>% select(country, year, malaria)
new_malaria_prop <-malaira_prop1 %>% unite(country, year, col="country_year", sep="_")

#Agriculture: the percent of a country's total land area that used for permanently for crops or pasture
agriculture1 <- agriculture %>% pivot_longer(c("1995":"2005"), names_to="year", values_to="agriculture") %>% select(country, year, agriculture)
new_agriculture <-agriculture1 %>% unite(country, year, col="country_year", sep="_")

#Livestock: An index that provides a measure of livestock production outputs (meat, milk, etc.) for a country each year
livestock1 <- livestock %>% pivot_longer(c("1995":"2005"), names_to="year", values_to="livestock") %>% select(country, year, livestock)
new_livestock <- livestock1 %>% unite(country, year, col="country_year", sep="_")

```

    
#### Joining/Merging

```{R}
# your joining code
first_join<- inner_join(new_forest, new_malaria_prop, by="country_year")
second_join<- inner_join(new_agriculture, new_livestock, by="country_year")
final_join <- inner_join(first_join, second_join, by="country_year")

#separate country and year
final_join<- final_join %>% separate("country_year", into=c("country", "year"), sep="_")

#total rows in each dataset
nrow(forest_coverage)
nrow(malaria_prop)
nrow(agriculture)
nrow(livestock)

#unique IDs in each dataset
n_distinct(forest_coverage)
n_distinct(malaria_prop)
n_distinct(agriculture)
n_distinct(livestock)

#IDs that appear in one dataset but not the other
anti<- forest_coverage %>% anti_join(malaria_prop, by="country")
anti %>% summarize(n_distinct(country))
head(anti)

#IDs that the datasets have in common
final_join %>% summarize(n_distinct(country))

#Additional code for discussion
malaria_prop %>% anti_join(final_join, by="country")
n_distinct(forest_coverage)- final_join %>% summarize(n_distinct(country))

```
Process:
I joined all 4 datasets together using inner_join. I chose to use inner_join because allowed me to keep only the data that had a match for each country in the years between 1995 and 2005. Thus, if the livestock data did not include an entry for Angola, then Angola would not be included in the final dataset. After I joined all the data together, I used separate to split the "country_year" variable into "country" (the ID variable) and "year." In the end, I had six variables in total (country, year, percent of land that is covered in forest compared to total land area (forest_cover), percent of land that is used for agriculture compared to total land area (agriculture), livestock production index (livestock), and malaria (malaria cases per 100,000 people)).

Calculations Discussion: There are 230 rows in the forest dataset, 107 rows in the malaria dataset, 211 rows in the agriculture dataset, and 202 rows in the livestock dataset. The number of distinct IDs is the same for each dataset because there are no duplicate data points of the countries. There are 123 IDs in the forest dataset that are missing in the malaria dataset, which indicates that 123 countries are not included in the malaria dataset but are present in the forest data. This includes Aruba and the Netherlands Antilles. As demonstrated by the final inner_join between the 4 datasets ("final_join"), the datasets have 106 ID variables in common. In other words, there are 106 countries that appear in all 4 datasets. The size of the final joined data is about half of the size of original datasets, except for the malaria data. Only one country, French Guiana, appeared in the malaria dataset but not the final joined dataset. Based on the forest data, I've lost 124 ID variables. Losing data points could have a negative impact on the analyses of these data because the results are less likely to be representative of the real world. Additionally, having a large sample size is important to reduce the margin of error and to decrease how much outliers can skew the data. Therefore, I have an increased risk of having resuts that are inaccurate and less representative of trends that are actually happening in the real world.


####  Wrangling

```{R}
# your wrangling code
#convert variables to numeric
final_join$year <-as.numeric(as.character(final_join$year))
final_join$malaria <- as.numeric(sub("k", "e3", final_join$malaria, fixed= TRUE))

#reorganize data
final_join<- final_join %>% select(country, year, forest_cover, agriculture, everything())

```

```{R}
#Summary Statistics Demonstration
library(knitr)
library(kableExtra)

#1: Average number of malaria cases (per 100,000 people) for each country from 1995-2005
final_join %>% group_by(country) %>% na.omit() %>% summarize(mean_malaria=mean(malaria)) %>% arrange(desc(mean_malaria)) %>% head() %>% kable(align = 'l', digits = 3) %>% kable_styling(font_size = 15)

final_join %>% group_by(country) %>% na.omit() %>% summarize(mean_malaria=mean(malaria)) %>% filter(country=="China")

#2: Categorical variable table of counts
final_join %>% group_by(country) %>% na.omit %>% summarize(n=n())

#3: Missing values for each variable- Define a function (user-defined) and use it inside summarize
final_join %>% summarize_all(function(x) sum(is.na(x)))

#4: Overall Summary Statistics for Livestock Production Index and Forest Cover using different functions
final_join %>% group_by(country) %>% na.omit() %>% summarize(sd_livestock=sd(livestock), sd_forest=sd(forest_cover), mean_livestock=mean(livestock), mean_forest=mean(forest_cover), n=n(), se_livestock=sd_livestock/sqrt(n), se_forest=sd_forest/sqrt(n)) %>% select(country, n, mean_livestock, mean_forest, everything()) %>% arrange(desc(mean_livestock)) %>% head() %>% kable(align = 'lccccccc', digits = 3) %>% kable_styling(font_size = 10) 

#5: Summary Statistics for Countries that overlap with the Amazon Rainforest
final_join %>% filter(country %in% c("Brazil","Columbia", "Peru", "Bolivia", "Venezuela", "Guyana", "Suriname")) %>% group_by(country) %>% na.omit() %>% summarize(mean_malaria=mean(malaria), mean_livestock=mean(livestock), mean_agriculture=mean(agriculture), mean_forest=mean(forest_cover)) %>% select(country, mean_malaria, mean_forest, mean_agriculture, mean_livestock) %>% arrange(mean_malaria) %>% kable(align = 'lcccc', digits = 3) %>% kable_styling(font_size = 15)

```
For #1, I grouped the data by country and used summarize to find the average number of malaria cases (per 100,000 people) from 1995-2005. I then arranged the resulting data from highest malaria incidence rate to lowest and found that Zambia had the highest overall rate of malaria incidence (35,800 cases/100,000 people). I was also curious to see what China's overal malaria incidence rate was because China is undergoing significant agricultural expansion and intensification, and the rate of malaria incidence was much lower than Zambia's (6.04 cases/100,000 people). For #2, I found the counts of the categorical variable (country) for each level, and it was 11 for most countries. This is logical because I used data from countries for each year between 1995 and 2005 (11 years total, and some countries might be missing data for a few years). For #3, I created a function inside of summarize to report the number of missing values for each variable. For #4, I found summary statistics using functions such as mean, sd, etc. for forest cover and the Livestock Production Index for each country averaged over the 11 yeats. The data are arranged from highest to lowest livestock production because I was curious to see if there appeared to be a relationship between livestock production and forest cover. For #5, I filtered the data to only include Amazonian countries, calculated the averages of the variables using summarize and the mean, and arranged the data from lowest to highest malaria incidence rate. It appears that Amazonian countries that have less forest cover have a lower average rate of malaria incidence (between 1995-2005).


```{R}
#5: Continued Summary Statistics Demonstration- Nigeria's Statistics
library(gt)

Nigeria_table<- final_join %>% filter(country=="Nigeria") %>% mutate("malaria/forest_cover"=malaria/forest_cover) %>% select(-agriculture, -livestock)

Nigeria_table %>% gt %>% tab_header(title=md("**Nigeria**"), subtitle=md("A table of malaria cases per 100,000 people and the percent of land covered in forest")) %>% tab_spanner(label="Variables", columns=c("country", "year","malaria", "forest_cover", "malaria/forest_cover"))

#6: stringr demonstration
final_join %>% distinct(country) %>% summarize("n_countries_2+_words"=sum(str_detect(country, "[ ]")))

```
For #5, I filtered the data only show data for Nigeria, which is a country known for having one of the highest rates of deforestation. I used mutate to create a new variable comparing the rate of malaria incidence as a function of the percent of land covered by forest, and I used gt to create a table to depict the data for each year. It appears that as the percent of land covered in forest decreases, the rate of malaria cases increases over time. For #6, I used str_detect to find countries that whose names are longer than 2 words long


```{R}
#4 Proportion of land use for agriculture to land covered in forest
final_join %>% mutate(prop_land=agriculture/forest_cover) %>% select(country, year, forest_cover, agriculture, prop_land)


#unique function 3
final_join %>% na.omit %>% mutate(livestock_agri=livestock/agriculture) %>% select(country, year, livestock, agriculture, livestock_agri)
```

#### Visualizing

```{R}
# Plot #1
library(ggplot2)

ggplot(data = final_join, aes(x = agriculture, y = forest_cover)) + geom_point(aes(color=year, size=malaria))+
  geom_smooth(method="lm")+ scale_color_gradient(low="green", high="red")+ ggtitle("Land Used for Agriculture vs Covered in Forest in Different Countries")+ xlab("Percent of Land Used for Agriculture")+ ylab("Percent of Land Covered in Forest")+ scale_y_continuous(breaks=seq(0, 100, 10))+ scale_x_continuous(breaks=seq(0, 100, 10))+ theme_gray()+ theme(plot.title=element_text(hjust=0.5, size=11), axis.title=element_text(size=9))

```

In Plot #1, I graphed the percent of land used for agriculture against the percent of land covered in forest for different countries. I colored the data points by year and changed the size of the datapoints based on the number of malaria cases (per 100,000 people). There is a negative correlation between percent of land used for agriculture versus used for forest. Additionally, the datapoints turn from green to red from left to right. This indicates that over time, increased land is being converted for agricultural purposes, and decreased land is covered in forest. Based on background research, there appears to be a causative relationship between decreased forest cover and increased agricultural land: deforestation occurs in order to create space for agricultural production because as the global population increases, the demand for food has increased. However, the plot above simply show a correlation between these variables.

```{R}
#Plot #2
amazon <- final_join %>% filter(country %in% c("Brazil","Columbia", "Peru", "Bolivia", "Venezuela", "Guyana", "Suriname"))

 ggplot(amazon, aes(x = country, y = malaria))+
  geom_bar(aes(fill=country), stat="summary",fun=mean)+
  geom_errorbar(stat="summary", fun.data=mean_se, width=.5)+ ggtitle("Average Malaria Incidence Rate in Amazonian Countries (1995-2005)")+ xlab("Country")+ ylab("Malaria Cases (per 100,000 people)")+ theme(legend.position="none")+ theme(plot.title=element_text(hjust=0.5), axis.text=element_text(size=10))+ scale_y_continuous(breaks=seq(0, 5000, 500))


```

In Plot #2, I created a bar graph depicting the average number of malaria cases (per 100,000 people) in countries that overlap with the Amazon Rainforest between the years 1995 and 20005. I chose to graph these countries because background research indicates that the Amazon is undergoing significant deforestation, and the wildlife-human interface (contact between humans, malaria-carrying mosquitoes, and  animals that are food sources for mosquitoes) as changed as a reuslt. Guyana had the most variation in malaria cases between the years, and Venezuela's malaria cases were fairly constant across the 11 years. Additionally, countries that had higher rates of malaria incidence also tended to have larger stanard deviations (i.e. there is more variation in the rate of malaria cases over time in countries that tend to have larger overall rates of malaria cases). 

```{R}
# Plot #3
deforest <- final_join %>% filter(country %in% c("Nigeria","Honduras", "Philippines", "Benin", "Ghana", "Indonesia", "Nepal"))

ggplot(data = deforest, aes(x= year, y= livestock))+ geom_point(aes(color=country), size=2)+ geom_smooth(aes(color=country), method="lm", se=F, size=.5)+ theme_gray()+ ggtitle("Livestock Production in Countries with High Deforestation Rates")+ ylab("Livestock Production Index")+ xlab("Year")+ scale_x_continuous(breaks=seq(1995, 2005, 1))+ geom_point(stat="summary", size=4)+ geom_smooth(method="lm", color="black")+ theme(plot.title=element_text(hjust=0.5))+ scale_color_discrete("Country")

```

According to previous research, global demand for animal products has increased, especially demand for meat, as countries across the globe become more developed. As a result, livestock production is increasing. Additionally, raising animals for meat uses a significant amount of land and is noted as one of the primary drivers of deforestation. In Plot #3 I graphed the Livestock Production Index of 7 countries that are known for having high rates of deforestation. (The Livestock Production Index is a measure created to assess the amount of animal products produced in different countries, and the values range from 32.64 to 359.72). There is a positive correlation between time and the Livestock Production Index. In other words, as time passes (between 1995-2005), the magnitude of livestock production in countries with high deforestation rates increases. I also graphed the overall Livestock Production Index of these countries overtime (the black datapoints). Based on the plot, it appears that overall livestock production increased from 58 to 88 from 1995 to 2005.

#### Concluding Remarks

Based on the analyses above, there appears to be a relationship between environmental factors and the incidence of malaria. (However, it is important to note that all of these analyses show correlations and therefore do not show causative relationships between the variables.) It was interesting to take patterns that are observed in the real world and apply data science techniques to them to see if my analyses also demonstrated these trends. Environmental factors have also been studied in the context of zoonotic emergence (Ebola, SARS-CoV-2, Nipah, etc.), so it could be interesting to analyze the relationship between the emergence of zoonoses and the presence of environmental factors at their outbreak sites. 




